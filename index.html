<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>如宝的数学闯关（两位/三位 ≤150）</title>
<style>
  :root{
    --bg1:#e8f7ff;
    --bg2:#fff;
    --accent:#ffb6c1;
    --card:#fff;
    --btn:#ffcc66;
    --btn-hover:#ff9b2b;
    --ok:#3bc371;
    --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "PingFang SC","Microsoft Yahei","Noto Sans SC",sans-serif;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#222;
    display:flex;
    flex-direction:column;
    min-height:100vh;
    align-items:center;
    padding:12px;
  }
  header{
    width:100%;
    max-width:1000px;
    padding:12px 16px;
    background:linear-gradient(90deg,var(--accent),#ffdede);
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px;
  }
  header h1{ margin:0; font-size:1.2rem; display:flex; gap:8px; align-items:center;}
  header .meta{ font-size:0.95rem; color:#333; opacity:0.95;}

  .game{
    width:100%;
    max-width:1000px;
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:14px;
  }
  /* 主面板 */
  .panel{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    box-shadow:0 8px 24px rgba(0,0,0,0.06);
  }
  .left{ min-height:520px; display:flex; flex-direction:column; align-items:center; gap:12px; }
  .right{ min-height:520px; }

  /* 顶部关卡/进度条 */
  .top-info{
    width:100%;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  .level { font-weight:700; font-size:1.05rem; }
  .progress {
    font-size:0.95rem;
    color:#444;
  }

  /* 猫咪显示区 */
  .cat-area{
    width:100%;
    max-width:560px;
    height:260px;
    background:linear-gradient(180deg,#fff8f2,#fff);
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:visible;
  }

  /* GIF 猫咪样式 */
  .cat-gif{ width:220px; height:auto; transition:transform .18s ease, opacity .2s ease; border-radius:12px; }
  .hidden{ display:none !important; opacity:0; }

  /* 开心乱窜：快速左右摆动（作用在容器而不是GIF本身也可） */
  .crazy { animation: crazyMove 0.55s ease-in-out infinite; }
  @keyframes crazyMove {
    0%{ transform: translateX(-20px) rotate(-6deg) scale(1.02) }
    50%{ transform: translateX(20px) rotate(6deg) scale(1.06) }
    100%{ transform: translateX(-20px) rotate(-6deg) scale(1.02) }
  }

  /* 沮丧：轻微下沉 + 灰化 */
  .sad { animation: sadBreathe 1s ease-in-out; filter:grayscale(.1) contrast(.95); }
  @keyframes sadBreathe { 0%{transform:translateY(0)} 50%{transform:translateY(6px) scale(.995)} 100%{transform:translateY(0)} }

  /* 鱼干掉落 */
  .fish{
    position:absolute;
    top:6px;
    font-size:1.9rem;
    animation: fishFall .9s cubic-bezier(.2,.9,.2,1);
    pointer-events:none;
  }
  @keyframes fishFall { 0%{transform:translateY(-6px) scale(.95) rotate(-6deg);opacity:1} 70%{transform:translateY(130px) scale(1.02) rotate(10deg);opacity:1} 100%{transform:translateY(180px) scale(.9) rotate(10deg);opacity:0} }

  /* 题目与选项 */
  .question {
    font-size:1.6rem;
    font-weight:800;
    background:linear-gradient(90deg,#fff,#fff8e6);
    padding:10px 14px;
    border-radius:10px;
    box-shadow:0 6px 16px rgba(0,0,0,.04);
    min-width:260px;
    text-align:center;
  }
  .options {
    width:100%;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin-top:6px;
  }
  .options button{
    min-width:110px;
    padding:10px 12px;
    font-size:1.05rem;
    background:var(--btn);
    border-radius:10px;
    border:0;
    cursor:pointer;
    box-shadow:0 6px 0 rgba(0,0,0,0.06);
  }
  .options button:hover{ background:var(--btn-hover); color:#fff; }

  .input-mode{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top:6px; }
  input[type="number"]{
    font-size:1.05rem; padding:8px 12px; border-radius:8px; border:1px solid #ddd; width:140px; text-align:center;
  }
  .controls-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:8px; flex-wrap:wrap; }

  /* 右侧竖式卡片与设置 */
  .right .panel-inner{ display:flex; flex-direction:column; gap:12px; }
  .vcard{ padding:12px; border-radius:10px; background:linear-gradient(180deg,#fff,#fff8f7); box-shadow:0 6px 12px rgba(0,0,0,0.04); min-height:120px; }
  pre.vcols{
    font-family: "Courier New",monospace;
    font-size:1.05rem;
    margin:0;
    padding:6px;
    background:rgba(0,0,0,0.03);
    border-radius:6px;
    white-space:pre;
    text-align:right;
  }
  .switch {
    padding:8px 12px; border-radius:8px; background:#fff; border:1px solid #eee; cursor:pointer;
  }
  .small{ font-size:0.95rem; color:#555; }

  /* 关卡提示 */
  .badge{ padding:8px 10px; border-radius:8px; background:linear-gradient(90deg,#fff,#fff8e6); box-shadow:0 4px 10px rgba(0,0,0,0.04); }

  footer{ width:100%; max-width:1000px; margin-top:12px; text-align:center; color:#666; font-size:0.95rem; }

  /* 奖励系统动画 */
  @keyframes rewardSlide {
    0% { transform: translateX(100%); opacity: 0; }
    20% { transform: translateX(0); opacity: 1; }
    80% { transform: translateX(0); opacity: 1; }
    100% { transform: translateX(100%); opacity: 0; }
  }

  @keyframes upgradePulse {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
  }

  @keyframes confettiFall {
    0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
  }

  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  @keyframes celebrationBounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-30px); }
    60% { transform: translateY(-15px); }
  }

  @keyframes celebrationSpin {
    0% { transform: rotate(0deg) scale(0.5); }
    50% { transform: rotate(180deg) scale(1.2); }
    100% { transform: rotate(360deg) scale(1); }
  }

  /* 奖励显示区域 */
  .reward-display {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    margin: 8px 0;
  }

  /* 配色方案 */
  :root {
    --primary-color: #ff6b6b;
    --secondary-color: #4ecdc4;
    --accent-color: #45b7d1;
    --success-color: #96ceb4;
    --warning-color: #feca57;
  }

  /* 关卡配色变化 */
  .level-1 { --primary-color: #ff6b6b; --secondary-color: #4ecdc4; }
  .level-2 { --primary-color: #a8e6cf; --secondary-color: #ffd3a5; }
  .level-3 { --primary-color: #ffd3a5; --secondary-color: #fd9853; }
  .level-4 { --primary-color: #fd9853; --secondary-color: #a8e6cf; }
  .level-5 { --primary-color: #4ecdc4; --secondary-color: #45b7d1; }
  .level-6 { --primary-color: #45b7d1; --secondary-color: #96ceb4; }
  .level-7 { --primary-color: #96ceb4; --secondary-color: #feca57; }
  .level-8 { --primary-color: #feca57; --secondary-color: #ff6b6b; }
  .level-9 { --primary-color: #ff9a9e; --secondary-color: #fecfef; }
  .level-10 { --primary-color: #fecfef; --secondary-color: #a8e6cf; }

  /* 立体可爱风格增强 */
  .vcard {
    background: linear-gradient(145deg, #ffffff, #f0f0f0);
    border-radius: 20px;
    box-shadow: 
      8px 8px 16px rgba(0,0,0,0.1),
      -8px -8px 16px rgba(255,255,255,0.7);
    border: 2px solid rgba(255,255,255,0.3);
    transition: all 0.3s ease;
  }

  .vcard:hover {
    transform: translateY(-2px);
    box-shadow: 
      12px 12px 24px rgba(0,0,0,0.15),
      -12px -12px 24px rgba(255,255,255,0.8);
  }

  .switch {
    background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
    border: none;
    border-radius: 25px;
    box-shadow: 
      6px 6px 12px rgba(0,0,0,0.2),
      -6px -6px 12px rgba(255,255,255,0.3);
    transition: all 0.3s ease;
  }

  .switch:hover {
    transform: translateY(-1px);
    box-shadow: 
      8px 8px 16px rgba(0,0,0,0.25),
      -8px -8px 16px rgba(255,255,255,0.4);
  }

  .switch:active {
    transform: translateY(1px);
    box-shadow: 
      4px 4px 8px rgba(0,0,0,0.2),
      -4px -4px 8px rgba(255,255,255,0.3);
  }

  /* 答案按钮立体效果 */
  .answer-btn {
    background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
    border: none;
    border-radius: 20px;
    box-shadow: 
      6px 6px 12px rgba(0,0,0,0.2),
      -6px -6px 12px rgba(255,255,255,0.3);
    transition: all 0.3s ease;
  }

  .answer-btn:hover {
    transform: translateY(-2px);
    box-shadow: 
      8px 8px 16px rgba(0,0,0,0.25),
      -8px -8px 16px rgba(255,255,255,0.4);
  }

  .answer-btn:active {
    transform: translateY(1px);
    box-shadow: 
      4px 4px 8px rgba(0,0,0,0.2),
      -4px -4px 8px rgba(255,255,255,0.3);
  }

  /* 顶部横栏立体效果 */
  header {
    background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
    box-shadow: 
      0 8px 16px rgba(0,0,0,0.1),
      inset 0 1px 0 rgba(255,255,255,0.3);
    border-bottom: 3px solid rgba(255,255,255,0.2);
  }

  /* 隐藏奖励效果 */
  
  /* 泡泡效果 */
  .bubble {
    position: absolute;
    width: 40px;
    height: 40px;
    background: radial-gradient(circle, rgba(173, 216, 230, 0.6), rgba(135, 206, 250, 0.2));
    border-radius: 50%;
    pointer-events: none;
    animation: bubbleFloat 3s ease-in-out infinite;
    border: 2px solid rgba(135, 206, 250, 0.4);
  }
  
  @keyframes bubbleFloat {
    0% { 
      transform: translateY(0) scale(0.8);
      opacity: 0.8;
    }
    50% { 
      transform: translateY(-30px) scale(1.2);
      opacity: 1;
    }
    100% { 
      transform: translateY(-60px) scale(0.6);
      opacity: 0;
    }
  }
  
  /* 小老鼠玩具效果 */
  .mouse-toy {
    position: absolute;
    font-size: 32px;
    pointer-events: none;
    animation: mouseMove 4s ease-in-out infinite;
  }
  
  @keyframes mouseMove {
    0% { transform: translateX(0) translateY(0) rotate(0deg); }
    25% { transform: translateX(50px) translateY(-20px) rotate(10deg); }
    50% { transform: translateX(100px) translateY(0) rotate(-5deg); }
    75% { transform: translateX(50px) translateY(20px) rotate(8deg); }
    100% { transform: translateX(0) translateY(0) rotate(0deg); }
  }
  
  /* 撸猫效果 */
  .petting-hand {
    position: absolute;
    font-size: 120px;
    pointer-events: none;
    animation: pettingMove 2s ease-in-out infinite;
  }
  
  /* 修剪猫毛效果 */
  .scissors {
    position: absolute;
    font-size: 40px;
    pointer-events: none;
    animation: scissorsCut 1.5s ease-in-out infinite;
  }
  
  @keyframes scissorsCut {
    0% { transform: translateX(0) translateY(0) rotate(0deg); }
    25% { transform: translateX(10px) translateY(-5px) rotate(15deg); }
    50% { transform: translateX(20px) translateY(0) rotate(-10deg); }
    75% { transform: translateX(10px) translateY(5px) rotate(20deg); }
    100% { transform: translateX(0) translateY(0) rotate(0deg); }
  }
  
  /* 猫毛掉落效果 */
  .cat-hair {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #8b4513;
    border-radius: 50%;
    pointer-events: none;
    animation: hairFall 2s ease-out forwards;
  }
  
  @keyframes hairFall {
    0% { 
      transform: translateY(0) rotate(0deg); 
      opacity: 1; 
    }
    100% { 
      transform: translateY(80px) rotate(360deg); 
      opacity: 0; 
    }
  }
  
  /* 主人抱抱效果 */
  .hug-hands {
    position: absolute;
    font-size: 60px;
    pointer-events: none;
    animation: hugMove 3s ease-in-out infinite;
  }
  
  @keyframes hugMove {
    0% { transform: translateX(0) translateY(0) scale(1); }
    25% { transform: translateX(-20px) translateY(-10px) scale(1.1); }
    50% { transform: translateX(0) translateY(0) scale(1.2); }
    75% { transform: translateX(20px) translateY(-10px) scale(1.1); }
    100% { transform: translateX(0) translateY(0) scale(1); }
  }
  
  @keyframes pettingMove {
    0% { transform: translateX(0) translateY(0) rotate(0deg); }
    25% { transform: translateX(30px) translateY(-10px) rotate(15deg); }
    50% { transform: translateX(60px) translateY(0) rotate(-10deg); }
    75% { transform: translateX(30px) translateY(10px) rotate(20deg); }
    100% { transform: translateX(0) translateY(0) rotate(0deg); }
  }
  
  /* 奖励解锁提示 */
  .unlock-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
    color: white;
    padding: 20px 30px;
    border-radius: 15px;
    font-size: 18px;
    font-weight: bold;
    z-index: 1000;
    animation: unlockPulse 3s ease-out forwards;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  
  @keyframes unlockPulse {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    20% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
    80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
  }
  
  /* 动态提示文字效果 */
  .effect-speech {
    position: absolute;
    font-family: "PingFang SC", "Microsoft Yahei", "Noto Sans SC", sans-serif;
    font-size: 16px;
    font-weight: bold;
    color: #333;
    background: linear-gradient(45deg, #fff, #f0f8ff);
    padding: 8px 16px;
    border-radius: 20px;
    border: 2px solid #87ceeb;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    pointer-events: none;
    z-index: 15;
    white-space: nowrap;
    animation: speechBubble 3s ease-out forwards;
  }
  
  @keyframes speechBubble {
    0% { 
      transform: translateY(0) scale(0.8); 
      opacity: 0; 
    }
    15% { 
      transform: translateY(-10px) scale(1.1); 
      opacity: 1; 
    }
    85% { 
      transform: translateY(-10px) scale(1); 
      opacity: 1; 
    }
    100% { 
      transform: translateY(-20px) scale(0.9); 
      opacity: 0; 
    }
  }
  
  /* 泡泡效果专用提示 */
  .bubble-speech {
    color: #1e90ff;
    background: linear-gradient(45deg, #e6f3ff, #b3d9ff);
    border-color: #87ceeb;
  }
  
  /* 小老鼠效果专用提示 */
  .mouse-speech {
    color: #8b4513;
    background: linear-gradient(45deg, #fff8dc, #f5deb3);
    border-color: #daa520;
  }
  
  /* 撸猫效果专用提示 */
  .petting-speech {
    color: #ff69b4;
    background: linear-gradient(45deg, #ffe4e1, #ffb6c1);
    border-color: #ff69b4;
  }
  
  /* 修剪猫毛效果专用提示 */
  .scissors-speech {
    color: #ff4500;
    background: linear-gradient(45deg, #fff5ee, #ffd700);
    border-color: #ff8c00;
  }
  
  /* 主人抱抱效果专用提示 */
  .hug-speech {
    color: #8b008b;
    background: linear-gradient(45deg, #f0e6ff, #dda0dd);
    border-color: #9370db;
  }

  /* 倒计时样式 */
  .timer {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 18px;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 20;
    animation: timerPulse 1s ease-in-out infinite;
  }
  
  @keyframes timerPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  .timer.warning {
    background: linear-gradient(45deg, #ff4757, #ff3838);
    animation: timerWarning 0.5s ease-in-out infinite;
  }
  
  @keyframes timerWarning {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  
  /* 管理员设置面板 */
  .admin-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(145deg, #2c3e50, #34495e);
    color: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    z-index: 10000;
    display: none;
    min-width: 400px;
  }
  
  .admin-panel h3 {
    margin: 0 0 20px 0;
    text-align: center;
    color: #ecf0f1;
  }
  
  .admin-panel label {
    display: block;
    margin: 15px 0 5px 0;
    font-weight: bold;
  }
  
  .admin-panel input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    margin-bottom: 10px;
  }
  
  .admin-panel button {
    background: linear-gradient(45deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin: 5px;
    font-size: 14px;
  }
  
  .admin-panel button:hover {
    background: linear-gradient(45deg, #2980b9, #1f618d);
  }
  
  .admin-panel .close-btn {
    background: linear-gradient(45deg, #e74c3c, #c0392b);
  }
  
  .admin-panel .close-btn:hover {
    background: linear-gradient(45deg, #c0392b, #a93226);
  }
  
  /* 管理员钥匙按钮 */
  .admin-key-btn {
    position: absolute;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    border: 2px solid #ff8c00;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    transition: all 0.3s ease;
    z-index: 1000;
  }
  
  .admin-key-btn:hover {
    background: linear-gradient(45deg, #ffed4e, #ffd700);
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 16px rgba(255, 215, 0, 0.5);
  }
  
  .admin-key-btn:active {
    transform: translateY(-50%) scale(0.95);
  }
  
  /* 隐藏管理员按钮（保留作为备用） */
  .admin-trigger {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 20px;
    height: 20px;
    background: transparent;
    border: none;
    cursor: pointer;
    z-index: 1000;
    display: none; /* 隐藏备用按钮 */
  }

  /* 响应式 */
  @media (max-width:920px){
    .game{ grid-template-columns: 1fr; }
    .right{ order:2; }
    .left{ order:1; }
  }
</style>
</head>
<body>
  <header>
    <h1>🐱 如宝的数学闯关</h1>
    <div class="meta">
      <span class="level">第 <strong id="levelLabel">1</strong> 关</span>
      &nbsp;·&nbsp;
      <span class="progress">题 <span id="qIdx">0</span>/10　·　🥖 <strong id="catSticks">0</strong>　🐟 <strong id="fish">0</strong>　🥫 <strong id="cans">0</strong></span>
    </div>
    <button class="admin-key-btn" id="adminKeyBtn" title="管理员设置">🔑</button>
  </header>

  <div class="game">
    <!-- 左侧主区 -->
    <div class="panel left">
      <div class="top-info" style="width:100%">
        <div class="badge">每关 10 题，答对 ≥8 可过关</div>
        <div class="badge small">可切换选择题 / 填空题 · 可显示竖式</div>
      </div>

      <div class="cat-area" id="catArea" aria-hidden="false">
        <!-- 倒计时显示 -->
        <div class="timer" id="timer" style="display: none;">10</div>
        <!-- GIF 猫咪：等待 / 开心 / 伤心（使用 Base64 占位符） -->
        <!-- 修改为GitHub路径引用 -->
        <img id="cat-wait" class="cat-gif" alt="如宝等待" src="images/cat-wait.gif" />
        <img id="cat-crazy" class="cat-gif hidden" alt="如宝开心" src="images/cat-crazy.gif" />
        <img id="cat-sad" class="cat-gif hidden" alt="如宝难过" src="images/cat-sad.gif" />
        <!-- 鱼干容器 -->
        <div id="fishDropArea" style="position:absolute; inset:0; pointer-events:none;"></div>
      </div>

      <div class="question panel" id="question">题目加载中...</div>

      <!-- 选择题区域（5 个选项） -->
      <div class="options panel" id="optionsBox" style="min-height:120px; display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div class="options-row options" id="optionsRow"></div>
      </div>

      <!-- 填空模式 -->
      <div class="panel input-mode" id="fillBox" style="display:none; align-items:center; justify-content:center;">
        <input id="answerInput" type="number" placeholder="请输入答案" aria-label="输入答案"/>
        <button id="submitFill" class="switch">提交</button>
      </div>

      <div class="controls-row" style="margin-top:6px;">
        <button id="modeToggle" class="switch">切换到 填空题模式</button>
        <button id="showVertBtn" class="switch">隐藏竖式</button>
        <button id="soundToggle" class="switch" aria-pressed="true">音效：开</button>
        <button id="resetBtn" class="switch">重置关卡与分数</button>
      </div>
    </div>

    <!-- 右侧：竖式面板 & 设置 -->
    <div class="panel right">
      <div class="panel-inner">
        <div class="vcard">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong id="hintTitle">竖式提示</strong></div>
            <div class="small">（只展示排列，不给结果）</div>
          </div>
          <pre class="vcols" id="verticalArea">竖式已显示，点击"隐藏竖式"可隐藏</pre>
        </div>

        <div class="vcard">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
            <div>
              <div class="small">当前进度</div>
              <div style="font-weight:700; font-size:1.05rem;">第 <span id="levelNumber">1</span> 关 · 第 <span id="qNumber">1</span> 题 / 10</div>
            </div>
            <div style="text-align:right;">
              <div class="small">本关答对</div>
              <div style="font-weight:800; font-size:1.35rem;" id="correctThis">0</div>
            </div>
          </div>
        </div>

        <div class="vcard" style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="font-weight:700;">奖励系统</div>
          </div>
          <div id="rewardDisplay" class="reward-display">
            <div style="display: flex; gap: 15px; align-items: center; font-size: 14px;">
              <span>🥖 0</span>
              <span>🐟 0</span>
              <span>🥫 0</span>
            </div>
          </div>
          <div class="small">答对1题获得1个猫条，10个猫条换1个鱼干，10个鱼干换1个罐头！</div>
        </div>

        <div class="vcard" style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="font-weight:700;">说明</div>
          </div>
          <div class="small">规则：每关 10 题，答对 8 题或以上才能晋级下一关。题目与答案不超过 <strong>150</strong>。可在右侧查看竖式帮助（不显示答案）。</div>
        </div>
      </div>
    </div>
  </div>

  <footer>快乐游戏，快乐学习，快乐撸猫。</footer>
  
  <!-- 隐藏管理员按钮 -->
  <button class="admin-trigger" id="adminTrigger" title="管理员设置"></button>
  
  <!-- 管理员设置面板 -->
  <div class="admin-panel" id="adminPanel">
    <h3>🔧 管理员设置</h3>
    <label for="maxValue">最大数值设置：</label>
    <input type="number" id="maxValue" value="150" min="50" max="1000">
    
    <label for="timerValue">答题计时（秒）：</label>
    <input type="number" id="timerValue" value="20" min="5" max="60">
    
    <div style="text-align: center; margin-top: 20px;">
      <button id="saveSettings">保存设置</button>
      <button class="close-btn" id="closeAdmin">关闭</button>
    </div>
  </div>

<script>
/* ------------------------
   游戏逻辑实现
-------------------------*/
(() => {
  // DOM
  const qEl = document.getElementById('question');
  const optionsRow = document.getElementById('optionsRow');
  const optionsBox = document.getElementById('optionsBox');
  const fillBox = document.getElementById('fillBox');
  const answerInput = document.getElementById('answerInput');
  const submitFill = document.getElementById('submitFill');
  const modeToggle = document.getElementById('modeToggle');
  const showVertBtn = document.getElementById('showVertBtn');
  const verticalArea = document.getElementById('verticalArea');
  const fishDropArea = document.getElementById('fishDropArea');
  const catWait = document.getElementById('cat-wait');
  const catCrazy = document.getElementById('cat-crazy');
  const catSad = document.getElementById('cat-sad');
  const levelLabel = document.getElementById('levelLabel');
  const levelNumber = document.getElementById('levelNumber');
  const qIdx = document.getElementById('qIdx');
  const qNumber = document.getElementById('qNumber');
  const correctThis = document.getElementById('correctThis');
  const scoreEl = document.getElementById('score');
  const correctThreshold = 8; // pass threshold
  const perLevelCount = 10; // questions per level
  const resetBtn = document.getElementById('resetBtn');
  const modeLabelEl = document.getElementById('modeToggle');

  // 让重播逻辑有基准 src（基于 Base64）
  [catWait, catCrazy, catSad].forEach(el => {
    if (el && !el.getAttribute('data-src')) {
      el.setAttribute('data-src', el.src);
    }
  });

  // 游戏状态（保存在 localStorage）
  let game = {
    level: parseInt(localStorage.getItem('ruba_level')||'1',10),
    score: parseInt(localStorage.getItem('ruba_score')||'0',10),
    // per-level progress
    qIndex: parseInt(localStorage.getItem('ruba_qIndex')||'0',10), // 0..9
    correctInLevel: parseInt(localStorage.getItem('ruba_correct')||'0',10),
    // 新增奖励系统
    catSticks: parseInt(localStorage.getItem('ruba_catSticks')||'0',10), // 猫条
    fish: parseInt(localStorage.getItem('ruba_fish')||'0',10), // 鱼干
    cans: parseInt(localStorage.getItem('ruba_cans')||'0',10), // 罐头
    // 隐藏奖励解锁状态
    unlockedBubbles: localStorage.getItem('ruba_unlockedBubbles') === 'true',
    unlockedMice: localStorage.getItem('ruba_unlockedMice') === 'true',
    unlockedPetting: localStorage.getItem('ruba_unlockedPetting') === 'true',
    unlockedScissors: localStorage.getItem('ruba_unlockedScissors') === 'true',
    unlockedHug: localStorage.getItem('ruba_unlockedHug') === 'true',
  };

  // UI 初始显示
  levelLabel.textContent = game.level;
  levelNumber.textContent = game.level;
  if(scoreEl) scoreEl.textContent = game.score;
  qIdx.textContent = game.qIndex;
  qNumber.textContent = game.qIndex + 1;
  correctThis.textContent = game.correctInLevel;
  
  // 更新奖励显示
  updateRewardDisplay();
  
  // 应用关卡配色
  applyLevelColors();
  
  // 检查隐藏奖励解锁状态
  checkHiddenRewards();

  // 模式 choose / fill
  let mode = 'choose';

  // 当前题目对象
  let currentQ = null;
  
  // 隐藏奖励轮换计数器（用于测试）
  let rewardCounter = 0;
  
  // 游戏设置
  let gameSettings = {
    maxValue: parseInt(localStorage.getItem('ruba_maxValue') || '150', 10),
    timerValue: parseInt(localStorage.getItem('ruba_timerValue') || '20', 10)
  };
  
  // 倒计时相关
  let timer = null;
  let timeLeft = gameSettings.timerValue;
  let timerElement = document.getElementById('timer');

  // 工具：随机整数
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // 生成题目，确保至少有一个2位数或3位数
  function genQuestion(){
    const op = Math.random() > 0.5 ? '+' : '-';
    let a, b, ans;
    const maxVal = gameSettings.maxValue;
    
    if(op === '+'){
      // 确保至少有一个2位数或3位数
      if(Math.random() > 0.5) {
        // a是2位数或3位数
        a = randInt(10, maxVal - 10);
        const bMax = Math.max(10, Math.min(maxVal - 10, maxVal - a));
        b = randInt(10, bMax);
      } else {
        // b是2位数或3位数
        b = randInt(10, maxVal - 10);
        const aMax = Math.max(10, Math.min(maxVal - 10, maxVal - b));
        a = randInt(10, aMax);
      }
      ans = a + b;
      if(ans > maxVal){
        b = Math.max(10, maxVal - a);
        ans = a + b;
      }
    } else {
      // 减法：确保至少有一个2位数或3位数
      if(Math.random() > 0.5) {
        // a是2位数或3位数
        a = randInt(20, maxVal);
        b = randInt(10, Math.min(a, maxVal));
      } else {
        // b是2位数或3位数
        b = randInt(10, maxVal);
        a = randInt(b + 10, Math.min(maxVal, b + maxVal));
      }
      ans = a - b;
    }
    return { num1: a, num2: b, operator: op, answer: ans };
  }

  // 生成 10 个选项：正确 + 9 个干扰
  function genOptions(correct){
    const set = new Set([correct]);
    const maxVal = gameSettings.maxValue;
    
    // 生成不同类型的干扰选项
    while(set.size < 10){
      let cand;
      const rand = Math.random();
      
      if(rand < 0.3) {
        // 30%概率：接近正确答案的选项
        const delta = randInt(-10, 10);
        cand = correct + delta;
      } else if(rand < 0.5) {
        // 20%概率：个位数差异
        const delta = randInt(-5, 5);
        cand = correct + delta;
      } else if(rand < 0.7) {
        // 20%概率：十位数差异
        const delta = randInt(-50, 50);
        cand = correct + delta;
      } else if(rand < 0.85) {
        // 15%概率：完全随机
        cand = randInt(0, maxVal);
      } else {
        // 15%概率：常见错误答案（如个位数相加、十位数相加等）
        const tens = Math.floor(correct / 10) * 10;
        const ones = correct % 10;
        cand = tens + randInt(-20, 20);
      }
      
      if(cand >= 0 && cand <= maxVal) set.add(cand);
    }
    
    const arr = Array.from(set);
    // 随机打乱选项顺序
    for(let i=arr.length-1;i>0;i--){ 
      const j = Math.floor(Math.random()*(i+1)); 
      [arr[i],arr[j]]=[arr[j],arr[i]]; 
    }
    return arr;
  }

  // 倒计时功能
  function startTimer(){
    timeLeft = gameSettings.timerValue;
    timerElement.style.display = 'block';
    timerElement.textContent = timeLeft;
    timerElement.classList.remove('warning');
    
    timer = setInterval(() => {
      timeLeft--;
      timerElement.textContent = timeLeft;
      
      if(timeLeft <= 3) {
        timerElement.classList.add('warning');
      }
      
      if(timeLeft <= 0) {
        clearInterval(timer);
        timerElement.style.display = 'none';
        // 时间到，自动答错
        handleAnswer(-999); // 用一个不可能的值表示超时
      }
    }, 1000);
  }
  
  function stopTimer(){
    if(timer) {
      clearInterval(timer);
      timer = null;
    }
    timerElement.style.display = 'none';
  }

  // 显示题目与选项/填空
  function renderQuestion(){
    currentQ = genQuestion();
    qEl.textContent = `${currentQ.num1} ${currentQ.operator} ${currentQ.num2} = ?`;
    setCatState('wait');
    if(mode === 'choose'){
      optionsBox.style.display = 'flex';
      fillBox.style.display = 'none';
      renderOptions();
    } else {
      optionsBox.style.display = 'none';
      fillBox.style.display = 'flex';
      answerInput.value = '';
      answerInput.focus();
    }
    renderVertical(currentQ);
    qIdx.textContent = game.qIndex;
    qNumber.textContent = game.qIndex + 1;
    
    // 开始倒计时
    startTimer();
  }

  function renderOptions(){
    optionsRow.innerHTML = '';
    const arr = genOptions(currentQ.answer);
    arr.forEach(val => {
      const btn = document.createElement('button');
      btn.textContent = val;
      btn.addEventListener('click', ()=> { handleAnswer(val); });
      optionsRow.appendChild(btn);
    });
  }

  // 切换猫咪状态并重播 GIF
  function restartGif(img){
    const base = img.getAttribute('data-src') || img.src;
    if(!base) return;
    img.setAttribute('data-src', base.split('#')[0]);
    const bust = (img.getAttribute('data-src')||'') + '#' + Date.now();
    img.src = bust;
  }

  function setCatState(state){
    [catWait, catCrazy, catSad].forEach(el => { el.classList.add('hidden'); el.classList.remove('crazy','sad'); });
    if(state === 'wait'){
      catWait.classList.remove('hidden');
      restartGif(catWait);
    } else if(state === 'crazy'){
      catCrazy.classList.remove('hidden');
      restartGif(catCrazy);
    } else if(state === 'sad'){
      catSad.classList.remove('hidden');
      restartGif(catSad);
    }
  }

  // 鱼干动画
  function spawnFish(){
    const fish = document.createElement('div');
    fish.className = 'fish';
    fish.textContent = '🐟';
    const areaW = fishDropArea.clientWidth || 300;
    const left = Math.max(8, Math.min(areaW-36, (areaW/2 - 18) + randInt(-80,80)));
    fish.style.left = left + 'px';
    fishDropArea.appendChild(fish);
    setTimeout(()=> fish.remove(), 1000);
  }

  // 彩带动画
  function spawnConfetti(){
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.textContent = ['🎉', '✨', '🌟', '💫', '🎊'][randInt(0, 4)];
    const areaW = fishDropArea.clientWidth || 300;
    const left = Math.max(8, Math.min(areaW-36, (areaW/2 - 18) + randInt(-100,100)));
    confetti.style.left = left + 'px';
    confetti.style.animation = 'confettiFall 2s ease-out forwards';
    fishDropArea.appendChild(confetti);
    setTimeout(()=> confetti.remove(), 2000);
  }

  // 检查升级系统
  function checkUpgrade(){
    // 10个猫条换1个鱼干
    if(game.catSticks >= 10){
      game.catSticks -= 10;
      game.fish += 1;
      showUpgradeEffect('fish');
    }
    
    // 10个鱼干换1个罐头
    if(game.fish >= 10){
      game.fish -= 10;
      game.cans += 1;
      showUpgradeEffect('can');
    }
    
    // 检查隐藏奖励解锁
    checkHiddenRewards();
  }
  
  // 检查隐藏奖励解锁
  function checkHiddenRewards(){
    // 泡泡效果：5个罐头解锁
    if(game.cans >= 5 && !game.unlockedBubbles){
      game.unlockedBubbles = true;
      localStorage.setItem('ruba_unlockedBubbles', 'true');
      showUnlockNotification('🎉 解锁新奖励：猫咪洗澡泡泡效果！');
    }
    
    // 小老鼠玩具：10个罐头解锁
    if(game.cans >= 10 && !game.unlockedMice){
      game.unlockedMice = true;
      localStorage.setItem('ruba_unlockedMice', 'true');
      showUnlockNotification('🎊 解锁新奖励：小老鼠玩具！');
    }
    
    // 撸猫效果：15个罐头解锁
    if(game.cans >= 15 && !game.unlockedPetting){
      game.unlockedPetting = true;
      localStorage.setItem('ruba_unlockedPetting', 'true');
      showUnlockNotification('🌟 解锁新奖励：主人撸猫效果！');
    }
  }
  
  // 显示解锁通知
  function showUnlockNotification(message){
    const notification = document.createElement('div');
    notification.className = 'unlock-notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }

  // 显示升级效果
  function showUpgradeEffect(type){
    const upgradeDiv = document.createElement('div');
    upgradeDiv.className = 'upgrade-effect';
    upgradeDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
      color: white;
      padding: 20px 40px;
      border-radius: 20px;
      font-size: 24px;
      font-weight: bold;
      z-index: 1000;
      animation: upgradePulse 2s ease-out forwards;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    `;
    
    if(type === 'fish'){
      upgradeDiv.innerHTML = '🎉 恭喜！10个猫条换1个鱼干！🐟';
    } else if(type === 'can'){
      upgradeDiv.innerHTML = '🎊 太棒了！10个鱼干换1个罐头！🥫';
    }
    
    document.body.appendChild(upgradeDiv);
    setTimeout(()=> upgradeDiv.remove(), 2000);
  }

  // 显示奖励效果
  function showRewardEffect(type){
    const rewardDiv = document.createElement('div');
    rewardDiv.className = 'reward-effect';
    rewardDiv.style.cssText = `
      position: fixed;
      top: 20%;
      right: 20px;
      background: linear-gradient(45deg, #ff9a9e, #fecfef);
      color: #333;
      padding: 10px 20px;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      z-index: 999;
      animation: rewardSlide 1.5s ease-out forwards;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    `;
    
    if(type === 'catStick'){
      rewardDiv.innerHTML = '🥖 +1 猫条';
    }
    
    document.body.appendChild(rewardDiv);
    setTimeout(()=> rewardDiv.remove(), 1500);
  }

  // 更新奖励显示
  function updateRewardDisplay(){
    // 更新右上角显示
    document.getElementById('catSticks').textContent = game.catSticks;
    document.getElementById('fish').textContent = game.fish;
    document.getElementById('cans').textContent = game.cans;
    
    // 更新右侧奖励区域显示
    const rewardDisplay = document.getElementById('rewardDisplay');
    if(rewardDisplay){
      rewardDisplay.innerHTML = `
        <div style="display: flex; gap: 15px; align-items: center; font-size: 14px;">
          <span>🥖 ${game.catSticks}</span>
          <span>🐟 ${game.fish}</span>
          <span>🥫 ${game.cans}</span>
        </div>
      `;
    }
  }

  // 应用关卡配色
  function applyLevelColors(){
    const level = Math.min(game.level, 10); // 最多10种配色
    document.body.className = `level-${level}`;
  }
  
  // 隐藏奖励效果实现
  
  // 创建动态提示文字
  function createSpeechBubble(text, type, x, y) {
    const catArea = document.getElementById('catArea');
    const speech = document.createElement('div');
    speech.className = `effect-speech ${type}-speech`;
    speech.textContent = text;
    speech.style.left = x + 'px';
    speech.style.top = y + 'px';
    speech.style.transform = 'translate(-50%, -50%)';
    catArea.appendChild(speech);
    
    setTimeout(() => speech.remove(), 5000);
  }
  
  // 泡泡效果
  function createBubbles(){
    if(!game.unlockedBubbles) return;
    
    const catArea = document.getElementById('catArea');
    const bubbleCount = 8; // 增加泡泡数量
    
    // 显示提示文字
    const centerX = catArea.clientWidth / 2;
    const centerY = catArea.clientHeight / 2;
    createSpeechBubble('我爱泡泡，喜欢洗澡', 'bubble', centerX, centerY - 60);
    
    for(let i = 0; i < bubbleCount; i++){
      setTimeout(() => {
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        // 集中在中央区域，猫咪图片周围
        const offsetX = (Math.random() - 0.5) * 120; // 中央±60px范围
        const offsetY = (Math.random() - 0.5) * 80; // 中央±40px范围
        bubble.style.left = (centerX + offsetX) + 'px';
        bubble.style.top = (centerY + offsetY + 20) + 'px'; // 稍微偏下一点
        bubble.style.animationDelay = Math.random() * 2 + 's';
        // 随机大小变化
        const size = 30 + Math.random() * 20; // 30-50px
        bubble.style.width = size + 'px';
        bubble.style.height = size + 'px';
        catArea.appendChild(bubble);
        
        setTimeout(() => bubble.remove(), 5000);
      }, i * 200); // 减少间隔时间，让泡泡更密集
    }
  }
  
  // 小老鼠玩具效果
  function createMice(){
    if(!game.unlockedMice) return;
    
    const catArea = document.getElementById('catArea');
    const mouseCount = 5; // 增加小老鼠数量
    
    // 显示提示文字
    const centerX = catArea.clientWidth / 2;
    const centerY = catArea.clientHeight / 2;
    createSpeechBubble('Jerry Jerry 你别跑', 'mouse', centerX, centerY - 60);
    
    for(let i = 0; i < mouseCount; i++){
      setTimeout(() => {
        const mouse = document.createElement('div');
        mouse.className = 'mouse-toy';
        mouse.textContent = '🐭';
        // 集中在中央区域，猫咪图片周围
        const offsetX = (Math.random() - 0.5) * 140; // 中央±70px范围
        const offsetY = (Math.random() - 0.5) * 100; // 中央±50px范围
        mouse.style.left = (centerX + offsetX) + 'px';
        mouse.style.top = (centerY + offsetY) + 'px';
        mouse.style.animationDelay = Math.random() * 2 + 's';
        // 随机大小变化
        const size = 24 + Math.random() * 16; // 24-40px
        mouse.style.fontSize = size + 'px';
        catArea.appendChild(mouse);
        
        setTimeout(() => mouse.remove(), 5000);
      }, i * 500); // 减少间隔时间
    }
  }
  
  // 撸猫效果
  function createPettingHand(){
    if(!game.unlockedPetting) return;
    
    const catArea = document.getElementById('catArea');
    const centerX = catArea.clientWidth / 2;
    const centerY = catArea.clientHeight / 2;
    
    // 显示提示文字
    createSpeechBubble('主人 好舒服 我要睡着了...', 'petting', centerX, centerY - 80);
    
    setTimeout(() => {
      const hand = document.createElement('div');
      hand.className = 'petting-hand';
      hand.textContent = '✋';
      // 更靠中央，模拟抚摸猫咪头部
      hand.style.left = (centerX + (Math.random() - 0.5) * 20) + 'px'; // 中央±10px范围
      hand.style.top = (centerY - 20 + (Math.random() - 0.5) * 10) + 'px'; // 稍微偏上，更靠中央
      hand.style.transform = 'translate(-50%, -50%)';
      hand.style.zIndex = '10'; // 确保在最上层
      hand.style.opacity = '0.8'; // 稍微透明
      catArea.appendChild(hand);
      
      setTimeout(() => hand.remove(), 5000);
    }, Math.random() * 1000);
  }
  
  // 修剪猫毛效果
  function createScissors(){
    if(!game.unlockedScissors) return;
    
    const catArea = document.getElementById('catArea');
    const centerX = catArea.clientWidth / 2;
    const centerY = catArea.clientHeight / 2;
    
    // 显示提示文字
    createSpeechBubble('来个新发型，cool！', 'scissors', centerX, centerY - 60);
    
    // 创建剪刀
    const scissors = document.createElement('div');
    scissors.className = 'scissors';
    scissors.textContent = '✂️';
    scissors.style.left = (centerX + (Math.random() - 0.5) * 30) + 'px';
    scissors.style.top = (centerY - 10 + (Math.random() - 0.5) * 20) + 'px';
    scissors.style.transform = 'translate(-50%, -50%)';
    scissors.style.zIndex = '12';
    catArea.appendChild(scissors);
    
    // 创建掉落的猫毛
    for(let i = 0; i < 6; i++){
      setTimeout(() => {
        const hair = document.createElement('div');
        hair.className = 'cat-hair';
        hair.style.left = (centerX + (Math.random() - 0.5) * 60) + 'px';
        hair.style.top = (centerY + 20) + 'px';
        hair.style.animationDelay = Math.random() * 0.5 + 's';
        catArea.appendChild(hair);
        
        setTimeout(() => hair.remove(), 5000);
      }, i * 200);
    }
    
    setTimeout(() => scissors.remove(), 5000);
  }
  
  // 主人抱抱效果
  function createHug(){
    if(!game.unlockedHug) return;
    
    const catArea = document.getElementById('catArea');
    const centerX = catArea.clientWidth / 2;
    const centerY = catArea.clientHeight / 2;
    
    // 显示提示文字
    createSpeechBubble('乖乖如宝，来抱抱', 'hug', centerX, centerY - 60);
    
    // 创建双手环抱效果
    const leftHand = document.createElement('div');
    leftHand.className = 'hug-hands';
    leftHand.textContent = '🤗';
    leftHand.style.left = (centerX - 30) + 'px';
    leftHand.style.top = (centerY - 10) + 'px';
    leftHand.style.transform = 'translate(-50%, -50%)';
    leftHand.style.zIndex = '12';
    catArea.appendChild(leftHand);
    
    const rightHand = document.createElement('div');
    rightHand.className = 'hug-hands';
    rightHand.textContent = '🤗';
    rightHand.style.left = (centerX + 30) + 'px';
    rightHand.style.top = (centerY - 10) + 'px';
    rightHand.style.transform = 'translate(-50%, -50%)';
    rightHand.style.zIndex = '12';
    catArea.appendChild(rightHand);
    
    setTimeout(() => {
      leftHand.remove();
      rightHand.remove();
    }, 5000);
  }
  
  // 随机触发隐藏奖励效果（过关时触发）
  function triggerRandomRewardOnLevelUp(){
    // 强制解锁所有效果用于测试
    game.unlockedBubbles = true;
    game.unlockedMice = true;
    game.unlockedPetting = true;
    game.unlockedScissors = true;
    game.unlockedHug = true;
    
    const effects = ['bubbles', 'mice', 'petting', 'scissors', 'hug'];
    const randomEffect = effects[Math.floor(Math.random() * effects.length)];
    
    switch(randomEffect){
      case 'bubbles':
        createBubbles();
        break;
      case 'mice':
        createMice();
        break;
      case 'petting':
        createPettingHand();
        break;
      case 'scissors':
        createScissors();
        break;
      case 'hug':
        createHug();
        break;
    }
  }
  
  // 轮流触发隐藏奖励效果（测试模式）
  function triggerRotatingReward(){
    // 强制解锁所有效果用于测试
    game.unlockedBubbles = true;
    game.unlockedMice = true;
    game.unlockedPetting = true;
    game.unlockedScissors = true;
    game.unlockedHug = true;
    
    const effects = ['bubbles', 'mice', 'petting', 'scissors', 'hug'];
    const currentEffect = effects[rewardCounter % effects.length];
    
    switch(currentEffect){
      case 'bubbles':
        createBubbles();
        break;
      case 'mice':
        createMice();
        break;
      case 'petting':
        createPettingHand();
        break;
      case 'scissors':
        createScissors();
        break;
      case 'hug':
        createHug();
        break;
    }
    
    rewardCounter++;
  }
  
  // 随机触发隐藏奖励效果（原版本）
  function triggerRandomReward(){
    if(!game.unlockedBubbles && !game.unlockedMice && !game.unlockedPetting) return;
    
    const effects = [];
    if(game.unlockedBubbles) effects.push('bubbles');
    if(game.unlockedMice) effects.push('mice');
    if(game.unlockedPetting) effects.push('petting');
    
    if(effects.length > 0){
      const randomEffect = effects[Math.floor(Math.random() * effects.length)];
      
      switch(randomEffect){
        case 'bubbles':
          createBubbles();
          break;
        case 'mice':
          createMice();
          break;
        case 'petting':
          createPettingHand();
          break;
      }
    }
  }

  // 增强过关庆祝效果
  function showLevelUpCelebration(got){
    // 创建庆祝遮罩
    const celebrationOverlay = document.createElement('div');
    celebrationOverlay.className = 'celebration-overlay';
    celebrationOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
      background-size: 400% 400%;
      animation: gradientShift 3s ease infinite;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-family: 'PingFang SC', 'Microsoft Yahei', sans-serif;
    `;
    
    celebrationOverlay.innerHTML = `
      <div style="text-align: center; animation: celebrationBounce 1s ease-out;">
        <div style="font-size: 80px; margin-bottom: 20px; animation: celebrationSpin 2s ease-in-out;">🎉</div>
        <h1 style="font-size: 48px; margin: 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.3);">太棒了！</h1>
        <h2 style="font-size: 32px; margin: 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">第${game.level}关通过！</h2>
        <p style="font-size: 24px; margin: 20px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">答对了 ${got} / ${perLevelCount} 题</p>
        <div style="font-size: 20px; margin: 30px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
          <p>🥖 猫条: ${game.catSticks} | 🐟 鱼干: ${game.fish} | 🥫 罐头: ${game.cans}</p>
        </div>
        <div style="font-size: 18px; margin-top: 20px; opacity: 0.9;">
          <p>继续加油，解锁更多奖励！</p>
        </div>
      </div>
    `;
    
    document.body.appendChild(celebrationOverlay);
    
    // 5秒后移除庆祝界面并应用新配色
    setTimeout(()=> {
      celebrationOverlay.remove();
      applyLevelColors(); // 应用新关卡配色
      
      // 庆祝页面显示完毕后，触发随机隐藏奖励效果
      setTimeout(() => {
        triggerRandomRewardOnLevelUp();
      }, 1000); // 延迟1秒后显示效果
    }, 5000);
  }

  // 答题
  function handleAnswer(userVal){
    // 停止倒计时
    stopTimer();
    
    const correct = currentQ.answer;
    
    // 检查是否超时
    if(userVal === -999) {
      setCatState('sad');
      setTimeout(()=> {
        alert(`时间到！正确答案是 ${correct} （提示：可以打开竖式试试看哦）`);
      }, 200);
      game.qIndex += 1;
      localStorage.setItem('ruba_qIndex', game.qIndex);
      if(game.qIndex >= perLevelCount){
        setTimeout(()=> evaluateLevel(), 900);
      } else {
        setTimeout(()=> renderQuestion(), 800);
      }
      return;
    }
    
    if(Number(userVal) === correct){
      game.score += 1;
      game.correctInLevel += 1;
      
      // 新增：答对获得1个猫条
      game.catSticks += 1;
      
      // 检查升级
      checkUpgrade();
      
      if(scoreEl) scoreEl.textContent = game.score;
      correctThis.textContent = game.correctInLevel;
      updateRewardDisplay();
      
      localStorage.setItem('ruba_score', game.score);
      localStorage.setItem('ruba_catSticks', game.catSticks);
      localStorage.setItem('ruba_fish', game.fish);
      localStorage.setItem('ruba_cans', game.cans);
      
      setCatState('crazy');
      spawnFish();
      
      // 显示获得猫条的效果
      showRewardEffect('catStick');
      
      // 隐藏奖励效果现在在过关时触发，这里不触发
    } else {
      setCatState('sad');
      setTimeout(()=> {
        alert(`哎呀，答错啦！正确答案是 ${correct} （提示：可以打开竖式试试看哦）`);
      },200);
    }
    game.qIndex += 1;
    localStorage.setItem('ruba_qIndex', game.qIndex);
    localStorage.setItem('ruba_correct', game.correctInLevel);
    if(game.qIndex >= perLevelCount){
      setTimeout(()=> evaluateLevel(), 900);
    } else {
      setTimeout(()=> renderQuestion(), 800);
    }
  }

  // 评估关卡
  function evaluateLevel(){
    const got = game.correctInLevel;
    if(got >= correctThreshold){
      // 增强过关奖励效果
      showLevelUpCelebration(got);
      
      game.level += 1;
      game.qIndex = 0;
      game.correctInLevel = 0;
      localStorage.setItem('ruba_level', game.level);
      localStorage.setItem('ruba_qIndex', game.qIndex);
      localStorage.setItem('ruba_correct', game.correctInLevel);
      levelLabel.textContent = game.level;
      levelNumber.textContent = game.level;
      
      // 增强过关特效
      for(let i=0;i<12;i++){ setTimeout(() => spawnFish(), 60*i); }
      for(let i=0;i<8;i++){ setTimeout(() => spawnConfetti(), 100*i); }
      
      setTimeout(()=> renderQuestion(), 2000);
    } else {
      alert(`本关答对 ${got} / ${perLevelCount}（未达到 ${correctThreshold}）。再来一次吧！`);
      game.qIndex = 0;
      game.correctInLevel = 0;
      localStorage.setItem('ruba_qIndex', game.qIndex);
      localStorage.setItem('ruba_correct', game.correctInLevel);
      correctThis.textContent = game.correctInLevel;
      setTimeout(()=> renderQuestion(), 600);
    }
  }

  // 填空提交
  submitFill.addEventListener('click', ()=>{
    const v = parseInt(answerInput.value,10);
    if(Number.isFinite(v)) handleAnswer(v);
    else alert('请输入数字答案');
  });
  answerInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ submitFill.click(); } });

  // 切换模式
  modeToggle.addEventListener('click', ()=>{
    if(mode === 'choose'){ mode = 'fill'; modeToggle.textContent = '切换到 选择题模式'; }
    else { mode = 'choose'; modeToggle.textContent = '切换到 填空题模式'; }
    renderQuestion();
  });

  // 竖式显示逻辑
  let isVertShown = true;
  showVertBtn.addEventListener('click', ()=>{
    isVertShown = !isVertShown;
    showVertBtn.textContent = isVertShown ? '隐藏竖式' : '显示竖式';
    if(isVertShown && currentQ) renderVertical(currentQ);
    else verticalArea.textContent = '已隐藏竖式';
  });

  // 竖式格式化（不显示结果）
  function renderVertical(q){
    const a = q.num1.toString();
    const b = q.num2.toString();
    const maxlen = Math.max(a.length, b.length) + 1;
    const pad = (s, len) => s.padStart(len, ' ');
    const line1 = pad(a, maxlen);
    const line2 = q.operator + pad(b, maxlen - 1);
    const hr = '-'.repeat(maxlen);
    const empty = ' '.repeat(maxlen);
    verticalArea.textContent = `${line1}\n${line2}\n${hr}\n${empty}`;
  }

  // 重置
  resetBtn.addEventListener('click', ()=>{
    if(confirm('确认重置关卡与所有奖励吗？')) {
      game = { level:1, score:0, qIndex:0, correctInLevel:0, catSticks:0, fish:0, cans:0, unlockedBubbles:false, unlockedMice:false, unlockedPetting:false, unlockedScissors:false, unlockedHug:false };
      rewardCounter = 0;
      localStorage.setItem('ruba_level', '1');
      localStorage.setItem('ruba_score', '0');
      localStorage.setItem('ruba_qIndex', '0');
      localStorage.setItem('ruba_correct', '0');
      localStorage.setItem('ruba_catSticks', '0');
      localStorage.setItem('ruba_fish', '0');
      localStorage.setItem('ruba_cans', '0');
      localStorage.setItem('ruba_unlockedBubbles', 'false');
      localStorage.setItem('ruba_unlockedMice', 'false');
      localStorage.setItem('ruba_unlockedPetting', 'false');
      levelLabel.textContent = '1';
      levelNumber.textContent = '1';
      if(scoreEl) scoreEl.textContent = '0';
      qIdx.textContent = '0';
      qNumber.textContent = '1';
      correctThis.textContent = '0';
      updateRewardDisplay();
      renderQuestion();
    }
  });

  // 管理员面板功能
  const adminKeyBtn = document.getElementById('adminKeyBtn');
  const adminTrigger = document.getElementById('adminTrigger');
  const adminPanel = document.getElementById('adminPanel');
  const maxValueInput = document.getElementById('maxValue');
  const timerValueInput = document.getElementById('timerValue');
  const saveSettingsBtn = document.getElementById('saveSettings');
  const closeAdminBtn = document.getElementById('closeAdmin');
  
  // 密码验证
  let passwordAttempts = 0;
  const maxAttempts = 3;
  
  // 钥匙按钮点击事件
  adminKeyBtn.addEventListener('click', () => {
    const password = prompt('请输入管理员密码：');
    if(password === '5200') {
      adminPanel.style.display = 'block';
      maxValueInput.value = gameSettings.maxValue;
      timerValueInput.value = gameSettings.timerValue;
      passwordAttempts = 0;
    } else {
      passwordAttempts++;
      if(passwordAttempts >= maxAttempts) {
        alert('密码错误次数过多，请刷新页面后重试！');
        adminKeyBtn.style.display = 'none';
      } else {
        alert(`密码错误！还有 ${maxAttempts - passwordAttempts} 次机会`);
      }
    }
  });
  
  // 备用隐藏按钮（保留功能）
  adminTrigger.addEventListener('click', () => {
    const password = prompt('请输入管理员密码：');
    if(password === '5200') {
      adminPanel.style.display = 'block';
      maxValueInput.value = gameSettings.maxValue;
      timerValueInput.value = gameSettings.timerValue;
      passwordAttempts = 0;
    } else {
      passwordAttempts++;
      if(passwordAttempts >= maxAttempts) {
        alert('密码错误次数过多，请刷新页面后重试！');
        adminTrigger.style.display = 'none';
      } else {
        alert(`密码错误！还有 ${maxAttempts - passwordAttempts} 次机会`);
      }
    }
  });
  
  saveSettingsBtn.addEventListener('click', () => {
    const newMaxValue = parseInt(maxValueInput.value, 10);
    const newTimerValue = parseInt(timerValueInput.value, 10);
    
    if(newMaxValue < 50 || newMaxValue > 1000) {
      alert('最大数值必须在50-1000之间！');
      return;
    }
    
    if(newTimerValue < 5 || newTimerValue > 60) {
      alert('答题计时必须在5-60秒之间！');
      return;
    }
    
    gameSettings.maxValue = newMaxValue;
    gameSettings.timerValue = newTimerValue;
    
    localStorage.setItem('ruba_maxValue', newMaxValue);
    localStorage.setItem('ruba_timerValue', newTimerValue);
    
    alert('设置已保存！');
    adminPanel.style.display = 'none';
  });
  
  closeAdminBtn.addEventListener('click', () => {
    adminPanel.style.display = 'none';
  });
  
  // 点击面板外部关闭
  adminPanel.addEventListener('click', (e) => {
    if(e.target === adminPanel) {
      adminPanel.style.display = 'none';
    }
  });

  // init first question
  renderQuestion();
})();
</script>
</body>

</html>
