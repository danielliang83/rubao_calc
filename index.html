<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>如宝的数学闯关（两位/三位 ≤150）</title>
<style>
  :root{
    --bg1:#e8f7ff;
    --bg2:#fff;
    --accent:#ffb6c1;
    --card:#fff;
    --btn:#ffcc66;
    --btn-hover:#ff9b2b;
    --ok:#3bc371;
    --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "PingFang SC","Microsoft Yahei","Noto Sans SC",sans-serif;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#222;
    display:flex;
    flex-direction:column;
    min-height:100vh;
    align-items:center;
    padding:12px;
  }
  header{
    width:100%;
    max-width:1000px;
    padding:12px 16px;
    background:linear-gradient(90deg,var(--accent),#ffdede);
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px;
  }
  header h1{ margin:0; font-size:1.2rem; display:flex; gap:8px; align-items:center;}
  header .meta{ font-size:0.95rem; color:#333; opacity:0.95;}

  .game{
    width:100%;
    max-width:1000px;
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:14px;
  }
  /* 主面板 */
  .panel{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    box-shadow:0 8px 24px rgba(0,0,0,0.06);
  }
  .left{ min-height:520px; display:flex; flex-direction:column; align-items:center; gap:12px; }
  .right{ min-height:520px; }

  /* 顶部关卡/进度条 */
  .top-info{
    width:100%;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  .level { font-weight:700; font-size:1.05rem; }
  .progress {
    font-size:0.95rem;
    color:#444;
  }

  /* 猫咪显示区 */
  .cat-area{
    width:100%;
    max-width:560px;
    height:260px;
    background:linear-gradient(180deg,#fff8f2,#fff);
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:visible;
  }

  /* GIF 猫咪样式 */
  .cat-gif{ width:220px; height:auto; transition:transform .18s ease, opacity .2s ease; border-radius:12px; }
  .hidden{ display:none !important; opacity:0; }

  /* 开心乱窜：快速左右摆动（作用在容器而不是GIF本身也可） */
  .crazy { animation: crazyMove 0.55s ease-in-out infinite; }
  @keyframes crazyMove {
    0%{ transform: translateX(-20px) rotate(-6deg) scale(1.02) }
    50%{ transform: translateX(20px) rotate(6deg) scale(1.06) }
    100%{ transform: translateX(-20px) rotate(-6deg) scale(1.02) }
  }

  /* 沮丧：轻微下沉 + 灰化 */
  .sad { animation: sadBreathe 1s ease-in-out; filter:grayscale(.1) contrast(.95); }
  @keyframes sadBreathe { 0%{transform:translateY(0)} 50%{transform:translateY(6px) scale(.995)} 100%{transform:translateY(0)} }

  /* 鱼干掉落 */
  .fish{
    position:absolute;
    top:6px;
    font-size:1.9rem;
    animation: fishFall .9s cubic-bezier(.2,.9,.2,1);
    pointer-events:none;
  }
  @keyframes fishFall { 0%{transform:translateY(-6px) scale(.95) rotate(-6deg);opacity:1} 70%{transform:translateY(130px) scale(1.02) rotate(10deg);opacity:1} 100%{transform:translateY(180px) scale(.9) rotate(10deg);opacity:0} }

  /* 题目与选项 */
  .question {
    font-size:1.6rem;
    font-weight:800;
    background:linear-gradient(90deg,#fff,#fff8e6);
    padding:10px 14px;
    border-radius:10px;
    box-shadow:0 6px 16px rgba(0,0,0,.04);
    min-width:260px;
    text-align:center;
  }
  .options {
    width:100%;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin-top:6px;
  }
  .options button{
    min-width:110px;
    padding:10px 12px;
    font-size:1.05rem;
    background:var(--btn);
    border-radius:10px;
    border:0;
    cursor:pointer;
    box-shadow:0 6px 0 rgba(0,0,0,0.06);
  }
  .options button:hover{ background:var(--btn-hover); color:#fff; }

  .input-mode{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top:6px; }
  input[type="number"]{
    font-size:1.05rem; padding:8px 12px; border-radius:8px; border:1px solid #ddd; width:140px; text-align:center;
  }
  .controls-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:8px; flex-wrap:wrap; }

  /* 右侧竖式卡片与设置 */
  .right .panel-inner{ display:flex; flex-direction:column; gap:12px; }
  .vcard{ padding:12px; border-radius:10px; background:linear-gradient(180deg,#fff,#fff8f7); box-shadow:0 6px 12px rgba(0,0,0,0.04); min-height:120px; }
  pre.vcols{
    font-family: "Courier New",monospace;
    font-size:1.05rem;
    margin:0;
    padding:6px;
    background:rgba(0,0,0,0.03);
    border-radius:6px;
    white-space:pre;
    text-align:right;
  }
  .switch {
    padding:8px 12px; border-radius:8px; background:#fff; border:1px solid #eee; cursor:pointer;
  }
  .small{ font-size:0.95rem; color:#555; }

  /* 关卡提示 */
  .badge{ padding:8px 10px; border-radius:8px; background:linear-gradient(90deg,#fff,#fff8e6); box-shadow:0 4px 10px rgba(0,0,0,0.04); }

  footer{ width:100%; max-width:1000px; margin-top:12px; text-align:center; color:#666; font-size:0.95rem; }

  /* 响应式 */
  @media (max-width:920px){
    .game{ grid-template-columns: 1fr; }
    .right{ order:2; }
    .left{ order:1; }
  }
</style>
</head>
<body>
  <header>
    <h1>🐱 如宝的数学闯关</h1>
    <div class="meta">
      <span class="level">第 <strong id="levelLabel">1</strong> 关</span>
      &nbsp;·&nbsp;
      <span class="progress">题 <span id="qIdx">0</span>/10　·　鱼干: <strong id="score">0</strong></span>
    </div>
  </header>

  <div class="game">
    <!-- 左侧主区 -->
    <div class="panel left">
      <div class="top-info" style="width:100%">
        <div class="badge">每关 10 题，答对 ≥8 可过关</div>
        <div class="badge small">可切换选择题 / 填空题 · 可显示竖式</div>
      </div>

      <div class="cat-area" id="catArea" aria-hidden="false">
        <!-- GIF 猫咪：等待 / 开心 / 伤心（使用 Base64 占位符） -->
        <!-- 修改为GitHub路径引用 -->
        <img id="cat-wait" class="cat-gif" alt="如宝等待" src="images/cat-wait.gif" />
        <img id="cat-crazy" class="cat-gif hidden" alt="如宝开心" src="images/cat-crazy.gif" />
        <img id="cat-sad" class="cat-gif hidden" alt="如宝难过" src="images/cat-sad.gif" />
        <!-- 鱼干容器 -->
        <div id="fishDropArea" style="position:absolute; inset:0; pointer-events:none;"></div>
      </div>

      <div class="question panel" id="question">题目加载中...</div>

      <!-- 选择题区域（5 个选项） -->
      <div class="options panel" id="optionsBox" style="min-height:120px; display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div class="options-row options" id="optionsRow"></div>
      </div>

      <!-- 填空模式 -->
      <div class="panel input-mode" id="fillBox" style="display:none; align-items:center; justify-content:center;">
        <input id="answerInput" type="number" placeholder="请输入答案" aria-label="输入答案"/>
        <button id="submitFill" class="switch">提交</button>
      </div>

      <div class="controls-row" style="margin-top:6px;">
        <button id="modeToggle" class="switch">切换到 填空题模式</button>
        <button id="showVertBtn" class="switch">显示竖式</button>
        <button id="soundToggle" class="switch" aria-pressed="true">音效：开</button>
        <button id="resetBtn" class="switch">重置关卡与分数</button>
      </div>
    </div>

    <!-- 右侧：竖式面板 & 设置 -->
    <div class="panel right">
      <div class="panel-inner">
        <div class="vcard">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong id="hintTitle">竖式提示</strong></div>
            <div class="small">（只展示排列，不给结果）</div>
          </div>
          <pre class="vcols" id="verticalArea">点“显示竖式”有提示</pre>
        </div>

        <div class="vcard">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
            <div>
              <div class="small">当前进度</div>
              <div style="font-weight:700; font-size:1.05rem;">第 <span id="levelNumber">1</span> 关 · 第 <span id="qNumber">1</span> 题 / 10</div>
            </div>
            <div style="text-align:right;">
              <div class="small">本关答对</div>
              <div style="font-weight:800; font-size:1.35rem;" id="correctThis">0</div>
            </div>
          </div>
        </div>

        <div class="vcard" style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="font-weight:700;">说明</div>
          </div>
          <div class="small">规则：每关 10 题，答对 8 题或以上才能晋级下一关。题目与答案不超过 <strong>150</strong>。可在右侧查看竖式帮助（不显示答案）。</div>
        </div>
      </div>
    </div>
  </div>

  <footer>如需换猫咪图片或调整规则告诉我，我可以帮你继续优化（加音效、解锁道具等）。</footer>

<script>
/* ------------------------
   游戏逻辑实现
-------------------------*/
(() => {
  // DOM
  const qEl = document.getElementById('question');
  const optionsRow = document.getElementById('optionsRow');
  const optionsBox = document.getElementById('optionsBox');
  const fillBox = document.getElementById('fillBox');
  const answerInput = document.getElementById('answerInput');
  const submitFill = document.getElementById('submitFill');
  const modeToggle = document.getElementById('modeToggle');
  const showVertBtn = document.getElementById('showVertBtn');
  const verticalArea = document.getElementById('verticalArea');
  const fishDropArea = document.getElementById('fishDropArea');
  const catWait = document.getElementById('cat-wait');
  const catCrazy = document.getElementById('cat-crazy');
  const catSad = document.getElementById('cat-sad');
  const levelLabel = document.getElementById('levelLabel');
  const levelNumber = document.getElementById('levelNumber');
  const qIdx = document.getElementById('qIdx');
  const qNumber = document.getElementById('qNumber');
  const correctThis = document.getElementById('correctThis');
  const scoreEl = document.getElementById('score');
  const correctThreshold = 8; // pass threshold
  const perLevelCount = 10; // questions per level
  const resetBtn = document.getElementById('resetBtn');
  const modeLabelEl = document.getElementById('modeToggle');

  // 让重播逻辑有基准 src（基于 Base64）
  [catWait, catCrazy, catSad].forEach(el => {
    if (el && !el.getAttribute('data-src')) {
      el.setAttribute('data-src', el.src);
    }
  });

  // 游戏状态（保存在 localStorage）
  let game = {
    level: parseInt(localStorage.getItem('ruba_level')||'1',10),
    score: parseInt(localStorage.getItem('ruba_score')||'0',10),
    // per-level progress
    qIndex: parseInt(localStorage.getItem('ruba_qIndex')||'0',10), // 0..9
    correctInLevel: parseInt(localStorage.getItem('ruba_correct')||'0',10),
  };

  // UI 初始显示
  levelLabel.textContent = game.level;
  levelNumber.textContent = game.level;
  scoreEl.textContent = game.score;
  qIdx.textContent = game.qIndex;
  qNumber.textContent = game.qIndex + 1;
  correctThis.textContent = game.correctInLevel;

  // 模式 choose / fill
  let mode = 'choose';

  // 当前题目对象
  let currentQ = null;

  // 工具：随机整数
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // 生成题目，保证数字和结果 <= 150
  function genQuestion(){
    const op = Math.random() > 0.5 ? '+' : '-';
    let a,b,ans;
    if(op === '+'){
      a = randInt(10,140);
      const bMax = Math.max(10, Math.min(140, 150 - a));
      b = randInt(10, bMax);
      ans = a + b;
      if(ans > 150){
        b = Math.max(10, 150 - a);
        ans = a + b;
      }
    } else {
      a = randInt(10,150);
      b = randInt(10, Math.min(a,150));
      if(a - b > 150){
        b = a - 150;
      }
      ans = a - b;
    }
    return { num1: a, num2: b, operator: op, answer: ans };
  }

  // 生成 5 个选项：正确 + 4 个干扰
  function genOptions(correct){
    const set = new Set([correct]);
    while(set.size < 5){
      const delta = randInt(-20,20);
      const cand = correct + delta;
      if(cand >= 0 && cand <= 150) set.add(cand);
    }
    const arr = Array.from(set);
    for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }

  // 显示题目与选项/填空
  function renderQuestion(){
    currentQ = genQuestion();
    qEl.textContent = `${currentQ.num1} ${currentQ.operator} ${currentQ.num2} = ?`;
    setCatState('wait');
    if(mode === 'choose'){
      optionsBox.style.display = 'flex';
      fillBox.style.display = 'none';
      renderOptions();
    } else {
      optionsBox.style.display = 'none';
      fillBox.style.display = 'flex';
      answerInput.value = '';
      answerInput.focus();
    }
    if(isVertShown) renderVertical(currentQ);
    qIdx.textContent = game.qIndex;
    qNumber.textContent = game.qIndex + 1;
  }

  function renderOptions(){
    optionsRow.innerHTML = '';
    const arr = genOptions(currentQ.answer);
    arr.forEach(val => {
      const btn = document.createElement('button');
      btn.textContent = val;
      btn.addEventListener('click', ()=> { handleAnswer(val); });
      optionsRow.appendChild(btn);
    });
  }

  // 切换猫咪状态并重播 GIF
  function restartGif(img){
    const base = img.getAttribute('data-src') || img.src;
    if(!base) return;
    img.setAttribute('data-src', base.split('#')[0]);
    const bust = (img.getAttribute('data-src')||'') + '#' + Date.now();
    img.src = bust;
  }

  function setCatState(state){
    [catWait, catCrazy, catSad].forEach(el => { el.classList.add('hidden'); el.classList.remove('crazy','sad'); });
    if(state === 'wait'){
      catWait.classList.remove('hidden');
      restartGif(catWait);
    } else if(state === 'crazy'){
      catCrazy.classList.remove('hidden');
      restartGif(catCrazy);
    } else if(state === 'sad'){
      catSad.classList.remove('hidden');
      restartGif(catSad);
    }
  }

  // 鱼干动画
  function spawnFish(){
    const fish = document.createElement('div');
    fish.className = 'fish';
    fish.textContent = '🐟';
    const areaW = fishDropArea.clientWidth || 300;
    const left = Math.max(8, Math.min(areaW-36, (areaW/2 - 18) + randInt(-80,80)));
    fish.style.left = left + 'px';
    fishDropArea.appendChild(fish);
    setTimeout(()=> fish.remove(), 1000);
  }

  // 答题
  function handleAnswer(userVal){
    const correct = currentQ.answer;
    if(Number(userVal) === correct){
      game.score += 1;
      game.correctInLevel += 1;
      scoreEl.textContent = game.score;
      correctThis.textContent = game.correctInLevel;
      localStorage.setItem('ruba_score', game.score);
      setCatState('crazy');
      spawnFish();
    } else {
      setCatState('sad');
      setTimeout(()=> {
        alert(`哎呀，答错啦！正确答案是 ${correct} （提示：可以打开竖式试试看哦）`);
      },200);
    }
    game.qIndex += 1;
    localStorage.setItem('ruba_qIndex', game.qIndex);
    localStorage.setItem('ruba_correct', game.correctInLevel);
    if(game.qIndex >= perLevelCount){
      setTimeout(()=> evaluateLevel(), 900);
    } else {
      setTimeout(()=> renderQuestion(), 800);
    }
  }

  // 评估关卡
  function evaluateLevel(){
    const got = game.correctInLevel;
    if(got >= correctThreshold){
      alert(`太棒了！本关答对 ${got} / ${perLevelCount}，已通过并进入下一关！`);
      game.level += 1;
      game.qIndex = 0;
      game.correctInLevel = 0;
      localStorage.setItem('ruba_level', game.level);
      localStorage.setItem('ruba_qIndex', game.qIndex);
      localStorage.setItem('ruba_correct', game.correctInLevel);
      levelLabel.textContent = game.level;
      levelNumber.textContent = game.level;
      for(let i=0;i<6;i++){ setTimeout(spawnFish, 80*i); }
      setTimeout(()=> renderQuestion(), 900);
    } else {
      alert(`本关答对 ${got} / ${perLevelCount}（未达到 ${correctThreshold}）。再来一次吧！`);
      game.qIndex = 0;
      game.correctInLevel = 0;
      localStorage.setItem('ruba_qIndex', game.qIndex);
      localStorage.setItem('ruba_correct', game.correctInLevel);
      correctThis.textContent = game.correctInLevel;
      setTimeout(()=> renderQuestion(), 600);
    }
  }

  // 填空提交
  submitFill.addEventListener('click', ()=>{
    const v = parseInt(answerInput.value,10);
    if(Number.isFinite(v)) handleAnswer(v);
    else alert('请输入数字答案');
  });
  answerInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ submitFill.click(); } });

  // 切换模式
  modeToggle.addEventListener('click', ()=>{
    if(mode === 'choose'){ mode = 'fill'; modeToggle.textContent = '切换到 选择题模式'; }
    else { mode = 'choose'; modeToggle.textContent = '切换到 填空题模式'; }
    renderQuestion();
  });

  // 竖式显示逻辑
  let isVertShown = false;
  showVertBtn.addEventListener('click', ()=>{
    isVertShown = !isVertShown;
    showVertBtn.textContent = isVertShown ? '隐藏竖式' : '显示竖式';
    if(isVertShown && currentQ) renderVertical(currentQ);
    else verticalArea.textContent = '已隐藏竖式';
  });

  // 竖式格式化（不显示结果）
  function renderVertical(q){
    const a = q.num1.toString();
    const b = q.num2.toString();
    const maxlen = Math.max(a.length, b.length) + 1;
    const pad = (s, len) => s.padStart(len, ' ');
    const line1 = pad(a, maxlen);
    const line2 = q.operator + pad(b, maxlen - 1);
    const hr = '-'.repeat(maxlen);
    const empty = ' '.repeat(maxlen);
    verticalArea.textContent = `${line1}\n${line2}\n${hr}\n${empty}`;
  }

  // 重置
  resetBtn.addEventListener('click', ()=>{
    if(confirm('确认重置关卡与鱼干分数吗？')) {
      game = { level:1, score:0, qIndex:0, correctInLevel:0 };
      localStorage.setItem('ruba_level', '1');
      localStorage.setItem('ruba_score', '0');
      localStorage.setItem('ruba_qIndex', '0');
      localStorage.setItem('ruba_correct', '0');
      levelLabel.textContent = '1';
      levelNumber.textContent = '1';
      scoreEl.textContent = '0';
      qIdx.textContent = '0';
      qNumber.textContent = '1';
      correctThis.textContent = '0';
      renderQuestion();
    }
  });

  // init first question
  renderQuestion();
})();
</script>
</body>

</html>
