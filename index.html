<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¦‚å®çš„æ•°å­¦é—¯å…³ï¼ˆä¸¤ä½/ä¸‰ä½ â‰¤150ï¼‰</title>
<style>
  :root{
    --bg1:#e8f7ff;
    --bg2:#fff;
    --accent:#ffb6c1;
    --card:#fff;
    --btn:#ffcc66;
    --btn-hover:#ff9b2b;
    --ok:#3bc371;
    --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "PingFang SC","Microsoft Yahei","Noto Sans SC",sans-serif;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#222;
    display:flex;
    flex-direction:column;
    min-height:100vh;
    align-items:center;
    padding:12px;
  }
  header{
    width:100%;
    max-width:1000px;
    padding:12px 16px;
    background:linear-gradient(90deg,var(--accent),#ffdede);
    border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px;
  }
  header h1{ margin:0; font-size:1.2rem; display:flex; gap:8px; align-items:center;}
  header .meta{ font-size:0.95rem; color:#333; opacity:0.95;}

  .game{
    width:100%;
    max-width:1000px;
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:14px;
  }
  /* ä¸»é¢æ¿ */
  .panel{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    box-shadow:0 8px 24px rgba(0,0,0,0.06);
  }
  .left{ min-height:520px; display:flex; flex-direction:column; align-items:center; gap:12px; }
  .right{ min-height:520px; }

  /* é¡¶éƒ¨å…³å¡/è¿›åº¦æ¡ */
  .top-info{
    width:100%;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  .level { font-weight:700; font-size:1.05rem; }
  .progress {
    font-size:0.95rem;
    color:#444;
  }

  /* çŒ«å’ªæ˜¾ç¤ºåŒº */
  .cat-area{
    width:100%;
    max-width:560px;
    height:260px;
    background:linear-gradient(180deg,#fff8f2,#fff);
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:visible;
  }

  /* GIF çŒ«å’ªæ ·å¼ */
  .cat-gif{ width:220px; height:auto; transition:transform .18s ease, opacity .2s ease; border-radius:12px; }
  .hidden{ display:none !important; opacity:0; }

  /* å¼€å¿ƒä¹±çªœï¼šå¿«é€Ÿå·¦å³æ‘†åŠ¨ï¼ˆä½œç”¨åœ¨å®¹å™¨è€Œä¸æ˜¯GIFæœ¬èº«ä¹Ÿå¯ï¼‰ */
  .crazy { animation: crazyMove 0.55s ease-in-out infinite; }
  @keyframes crazyMove {
    0%{ transform: translateX(-20px) rotate(-6deg) scale(1.02) }
    50%{ transform: translateX(20px) rotate(6deg) scale(1.06) }
    100%{ transform: translateX(-20px) rotate(-6deg) scale(1.02) }
  }

  /* æ²®ä¸§ï¼šè½»å¾®ä¸‹æ²‰ + ç°åŒ– */
  .sad { animation: sadBreathe 1s ease-in-out; filter:grayscale(.1) contrast(.95); }
  @keyframes sadBreathe { 0%{transform:translateY(0)} 50%{transform:translateY(6px) scale(.995)} 100%{transform:translateY(0)} }

  /* é±¼å¹²æ‰è½ */
  .fish{
    position:absolute;
    top:6px;
    font-size:1.9rem;
    animation: fishFall .9s cubic-bezier(.2,.9,.2,1);
    pointer-events:none;
  }
  @keyframes fishFall { 0%{transform:translateY(-6px) scale(.95) rotate(-6deg);opacity:1} 70%{transform:translateY(130px) scale(1.02) rotate(10deg);opacity:1} 100%{transform:translateY(180px) scale(.9) rotate(10deg);opacity:0} }

  /* é¢˜ç›®ä¸é€‰é¡¹ */
  .question {
    font-size:1.6rem;
    font-weight:800;
    background:linear-gradient(90deg,#fff,#fff8e6);
    padding:10px 14px;
    border-radius:10px;
    box-shadow:0 6px 16px rgba(0,0,0,.04);
    min-width:260px;
    text-align:center;
  }
  .options {
    width:100%;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin-top:6px;
  }
  .options button{
    min-width:110px;
    padding:10px 12px;
    font-size:1.05rem;
    background:var(--btn);
    border-radius:10px;
    border:0;
    cursor:pointer;
    box-shadow:0 6px 0 rgba(0,0,0,0.06);
  }
  .options button:hover{ background:var(--btn-hover); color:#fff; }

  .input-mode{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top:6px; }
  input[type="number"]{
    font-size:1.05rem; padding:8px 12px; border-radius:8px; border:1px solid #ddd; width:140px; text-align:center;
  }
  .controls-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:8px; flex-wrap:wrap; }

  /* å³ä¾§ç«–å¼å¡ç‰‡ä¸è®¾ç½® */
  .right .panel-inner{ display:flex; flex-direction:column; gap:12px; }
  .vcard{ padding:12px; border-radius:10px; background:linear-gradient(180deg,#fff,#fff8f7); box-shadow:0 6px 12px rgba(0,0,0,0.04); min-height:120px; }
  pre.vcols{
    font-family: "Courier New",monospace;
    font-size:1.05rem;
    margin:0;
    padding:6px;
    background:rgba(0,0,0,0.03);
    border-radius:6px;
    white-space:pre;
    text-align:right;
  }
  .switch {
    padding:8px 12px; border-radius:8px; background:#fff; border:1px solid #eee; cursor:pointer;
  }
  .small{ font-size:0.95rem; color:#555; }

  /* å…³å¡æç¤º */
  .badge{ padding:8px 10px; border-radius:8px; background:linear-gradient(90deg,#fff,#fff8e6); box-shadow:0 4px 10px rgba(0,0,0,0.04); }

  footer{ width:100%; max-width:1000px; margin-top:12px; text-align:center; color:#666; font-size:0.95rem; }

  /* å“åº”å¼ */
  @media (max-width:920px){
    .game{ grid-template-columns: 1fr; }
    .right{ order:2; }
    .left{ order:1; }
  }
</style>
</head>
<body>
  <header>
    <h1>ğŸ± å¦‚å®çš„æ•°å­¦é—¯å…³</h1>
    <div class="meta">
      <span class="level">ç¬¬ <strong id="levelLabel">1</strong> å…³</span>
      &nbsp;Â·&nbsp;
      <span class="progress">é¢˜ <span id="qIdx">0</span>/10ã€€Â·ã€€é±¼å¹²: <strong id="score">0</strong></span>
    </div>
  </header>

  <div class="game">
    <!-- å·¦ä¾§ä¸»åŒº -->
    <div class="panel left">
      <div class="top-info" style="width:100%">
        <div class="badge">æ¯å…³ 10 é¢˜ï¼Œç­”å¯¹ â‰¥8 å¯è¿‡å…³</div>
        <div class="badge small">å¯åˆ‡æ¢é€‰æ‹©é¢˜ / å¡«ç©ºé¢˜ Â· å¯æ˜¾ç¤ºç«–å¼</div>
      </div>

      <div class="cat-area" id="catArea" aria-hidden="false">
        <!-- GIF çŒ«å’ªï¼šç­‰å¾… / å¼€å¿ƒ / ä¼¤å¿ƒï¼ˆä½¿ç”¨ Base64 å ä½ç¬¦ï¼‰ -->
        <!-- ä¿®æ”¹ä¸ºGitHubè·¯å¾„å¼•ç”¨ -->
        <img id="cat-wait" class="cat-gif" alt="å¦‚å®ç­‰å¾…" src="images/cat-wait.gif" />
        <img id="cat-crazy" class="cat-gif hidden" alt="å¦‚å®å¼€å¿ƒ" src="images/cat-crazy.gif" />
        <img id="cat-sad" class="cat-gif hidden" alt="å¦‚å®éš¾è¿‡" src="images/cat-sad.gif" />
        <!-- é±¼å¹²å®¹å™¨ -->
        <div id="fishDropArea" style="position:absolute; inset:0; pointer-events:none;"></div>
      </div>

      <div class="question panel" id="question">é¢˜ç›®åŠ è½½ä¸­...</div>

      <!-- é€‰æ‹©é¢˜åŒºåŸŸï¼ˆ5 ä¸ªé€‰é¡¹ï¼‰ -->
      <div class="options panel" id="optionsBox" style="min-height:120px; display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div class="options-row options" id="optionsRow"></div>
      </div>

      <!-- å¡«ç©ºæ¨¡å¼ -->
      <div class="panel input-mode" id="fillBox" style="display:none; align-items:center; justify-content:center;">
        <input id="answerInput" type="number" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" aria-label="è¾“å…¥ç­”æ¡ˆ"/>
        <button id="submitFill" class="switch">æäº¤</button>
      </div>

      <div class="controls-row" style="margin-top:6px;">
        <button id="modeToggle" class="switch">åˆ‡æ¢åˆ° å¡«ç©ºé¢˜æ¨¡å¼</button>
        <button id="showVertBtn" class="switch">æ˜¾ç¤ºç«–å¼</button>
        <button id="soundToggle" class="switch" aria-pressed="true">éŸ³æ•ˆï¼šå¼€</button>
        <button id="resetBtn" class="switch">é‡ç½®å…³å¡ä¸åˆ†æ•°</button>
      </div>
    </div>

    <!-- å³ä¾§ï¼šç«–å¼é¢æ¿ & è®¾ç½® -->
    <div class="panel right">
      <div class="panel-inner">
        <div class="vcard">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong id="hintTitle">ç«–å¼æç¤º</strong></div>
            <div class="small">ï¼ˆåªå±•ç¤ºæ’åˆ—ï¼Œä¸ç»™ç»“æœï¼‰</div>
          </div>
          <pre class="vcols" id="verticalArea">ç‚¹â€œæ˜¾ç¤ºç«–å¼â€æœ‰æç¤º</pre>
        </div>

        <div class="vcard">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
            <div>
              <div class="small">å½“å‰è¿›åº¦</div>
              <div style="font-weight:700; font-size:1.05rem;">ç¬¬ <span id="levelNumber">1</span> å…³ Â· ç¬¬ <span id="qNumber">1</span> é¢˜ / 10</div>
            </div>
            <div style="text-align:right;">
              <div class="small">æœ¬å…³ç­”å¯¹</div>
              <div style="font-weight:800; font-size:1.35rem;" id="correctThis">0</div>
            </div>
          </div>
        </div>

        <div class="vcard" style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="font-weight:700;">è¯´æ˜</div>
          </div>
          <div class="small">è§„åˆ™ï¼šæ¯å…³ 10 é¢˜ï¼Œç­”å¯¹ 8 é¢˜æˆ–ä»¥ä¸Šæ‰èƒ½æ™‹çº§ä¸‹ä¸€å…³ã€‚é¢˜ç›®ä¸ç­”æ¡ˆä¸è¶…è¿‡ <strong>150</strong>ã€‚å¯åœ¨å³ä¾§æŸ¥çœ‹ç«–å¼å¸®åŠ©ï¼ˆä¸æ˜¾ç¤ºç­”æ¡ˆï¼‰ã€‚</div>
        </div>
      </div>
    </div>
  </div>

  <footer>å¦‚éœ€æ¢çŒ«å’ªå›¾ç‰‡æˆ–è°ƒæ•´è§„åˆ™å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç»§ç»­ä¼˜åŒ–ï¼ˆåŠ éŸ³æ•ˆã€è§£é”é“å…·ç­‰ï¼‰ã€‚</footer>

<script>
/* ------------------------
   æ¸¸æˆé€»è¾‘å®ç°
-------------------------*/
(() => {
  // DOM
  const qEl = document.getElementById('question');
  const optionsRow = document.getElementById('optionsRow');
  const optionsBox = document.getElementById('optionsBox');
  const fillBox = document.getElementById('fillBox');
  const answerInput = document.getElementById('answerInput');
  const submitFill = document.getElementById('submitFill');
  const modeToggle = document.getElementById('modeToggle');
  const showVertBtn = document.getElementById('showVertBtn');
  const verticalArea = document.getElementById('verticalArea');
  const fishDropArea = document.getElementById('fishDropArea');
  const catWait = document.getElementById('cat-wait');
  const catCrazy = document.getElementById('cat-crazy');
  const catSad = document.getElementById('cat-sad');
  const levelLabel = document.getElementById('levelLabel');
  const levelNumber = document.getElementById('levelNumber');
  const qIdx = document.getElementById('qIdx');
  const qNumber = document.getElementById('qNumber');
  const correctThis = document.getElementById('correctThis');
  const scoreEl = document.getElementById('score');
  const correctThreshold = 8; // pass threshold
  const perLevelCount = 10; // questions per level
  const resetBtn = document.getElementById('resetBtn');
  const modeLabelEl = document.getElementById('modeToggle');

  // è®©é‡æ’­é€»è¾‘æœ‰åŸºå‡† srcï¼ˆåŸºäº Base64ï¼‰
  [catWait, catCrazy, catSad].forEach(el => {
    if (el && !el.getAttribute('data-src')) {
      el.setAttribute('data-src', el.src);
    }
  });

  // æ¸¸æˆçŠ¶æ€ï¼ˆä¿å­˜åœ¨ localStorageï¼‰
  let game = {
    level: parseInt(localStorage.getItem('ruba_level')||'1',10),
    score: parseInt(localStorage.getItem('ruba_score')||'0',10),
    // per-level progress
    qIndex: parseInt(localStorage.getItem('ruba_qIndex')||'0',10), // 0..9
    correctInLevel: parseInt(localStorage.getItem('ruba_correct')||'0',10),
  };

  // UI åˆå§‹æ˜¾ç¤º
  levelLabel.textContent = game.level;
  levelNumber.textContent = game.level;
  scoreEl.textContent = game.score;
  qIdx.textContent = game.qIndex;
  qNumber.textContent = game.qIndex + 1;
  correctThis.textContent = game.correctInLevel;

  // æ¨¡å¼ choose / fill
  let mode = 'choose';

  // å½“å‰é¢˜ç›®å¯¹è±¡
  let currentQ = null;

  // å·¥å…·ï¼šéšæœºæ•´æ•°
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // ç”Ÿæˆé¢˜ç›®ï¼Œä¿è¯æ•°å­—å’Œç»“æœ <= 150
  function genQuestion(){
    const op = Math.random() > 0.5 ? '+' : '-';
    let a,b,ans;
    if(op === '+'){
      a = randInt(10,140);
      const bMax = Math.max(10, Math.min(140, 150 - a));
      b = randInt(10, bMax);
      ans = a + b;
      if(ans > 150){
        b = Math.max(10, 150 - a);
        ans = a + b;
      }
    } else {
      a = randInt(10,150);
      b = randInt(10, Math.min(a,150));
      if(a - b > 150){
        b = a - 150;
      }
      ans = a - b;
    }
    return { num1: a, num2: b, operator: op, answer: ans };
  }

  // ç”Ÿæˆ 5 ä¸ªé€‰é¡¹ï¼šæ­£ç¡® + 4 ä¸ªå¹²æ‰°
  function genOptions(correct){
    const set = new Set([correct]);
    while(set.size < 5){
      const delta = randInt(-20,20);
      const cand = correct + delta;
      if(cand >= 0 && cand <= 150) set.add(cand);
    }
    const arr = Array.from(set);
    for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }

  // æ˜¾ç¤ºé¢˜ç›®ä¸é€‰é¡¹/å¡«ç©º
  function renderQuestion(){
    currentQ = genQuestion();
    qEl.textContent = `${currentQ.num1} ${currentQ.operator} ${currentQ.num2} = ?`;
    setCatState('wait');
    if(mode === 'choose'){
      optionsBox.style.display = 'flex';
      fillBox.style.display = 'none';
      renderOptions();
    } else {
      optionsBox.style.display = 'none';
      fillBox.style.display = 'flex';
      answerInput.value = '';
      answerInput.focus();
    }
    if(isVertShown) renderVertical(currentQ);
    qIdx.textContent = game.qIndex;
    qNumber.textContent = game.qIndex + 1;
  }

  function renderOptions(){
    optionsRow.innerHTML = '';
    const arr = genOptions(currentQ.answer);
    arr.forEach(val => {
      const btn = document.createElement('button');
      btn.textContent = val;
      btn.addEventListener('click', ()=> { handleAnswer(val); });
      optionsRow.appendChild(btn);
    });
  }

  // åˆ‡æ¢çŒ«å’ªçŠ¶æ€å¹¶é‡æ’­ GIF
  function restartGif(img){
    const base = img.getAttribute('data-src') || img.src;
    if(!base) return;
    img.setAttribute('data-src', base.split('#')[0]);
    const bust = (img.getAttribute('data-src')||'') + '#' + Date.now();
    img.src = bust;
  }

  function setCatState(state){
    [catWait, catCrazy, catSad].forEach(el => { el.classList.add('hidden'); el.classList.remove('crazy','sad'); });
    if(state === 'wait'){
      catWait.classList.remove('hidden');
      restartGif(catWait);
    } else if(state === 'crazy'){
      catCrazy.classList.remove('hidden');
      restartGif(catCrazy);
    } else if(state === 'sad'){
      catSad.classList.remove('hidden');
      restartGif(catSad);
    }
  }

  // é±¼å¹²åŠ¨ç”»
  function spawnFish(){
    const fish = document.createElement('div');
    fish.className = 'fish';
    fish.textContent = 'ğŸŸ';
    const areaW = fishDropArea.clientWidth || 300;
    const left = Math.max(8, Math.min(areaW-36, (areaW/2 - 18) + randInt(-80,80)));
    fish.style.left = left + 'px';
    fishDropArea.appendChild(fish);
    setTimeout(()=> fish.remove(), 1000);
  }

  // ç­”é¢˜
  function handleAnswer(userVal){
    const correct = currentQ.answer;
    if(Number(userVal) === correct){
      game.score += 1;
      game.correctInLevel += 1;
      scoreEl.textContent = game.score;
      correctThis.textContent = game.correctInLevel;
      localStorage.setItem('ruba_score', game.score);
      setCatState('crazy');
      spawnFish();
    } else {
      setCatState('sad');
      setTimeout(()=> {
        alert(`å“å‘€ï¼Œç­”é”™å•¦ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ ${correct} ï¼ˆæç¤ºï¼šå¯ä»¥æ‰“å¼€ç«–å¼è¯•è¯•çœ‹å“¦ï¼‰`);
      },200);
    }
    game.qIndex += 1;
    localStorage.setItem('ruba_qIndex', game.qIndex);
    localStorage.setItem('ruba_correct', game.correctInLevel);
    if(game.qIndex >= perLevelCount){
      setTimeout(()=> evaluateLevel(), 900);
    } else {
      setTimeout(()=> renderQuestion(), 800);
    }
  }

  // è¯„ä¼°å…³å¡
  function evaluateLevel(){
    const got = game.correctInLevel;
    if(got >= correctThreshold){
      alert(`å¤ªæ£’äº†ï¼æœ¬å…³ç­”å¯¹ ${got} / ${perLevelCount}ï¼Œå·²é€šè¿‡å¹¶è¿›å…¥ä¸‹ä¸€å…³ï¼`);
      game.level += 1;
      game.qIndex = 0;
      game.correctInLevel = 0;
      localStorage.setItem('ruba_level', game.level);
      localStorage.setItem('ruba_qIndex', game.qIndex);
      localStorage.setItem('ruba_correct', game.correctInLevel);
      levelLabel.textContent = game.level;
      levelNumber.textContent = game.level;
      for(let i=0;i<6;i++){ setTimeout(spawnFish, 80*i); }
      setTimeout(()=> renderQuestion(), 900);
    } else {
      alert(`æœ¬å…³ç­”å¯¹ ${got} / ${perLevelCount}ï¼ˆæœªè¾¾åˆ° ${correctThreshold}ï¼‰ã€‚å†æ¥ä¸€æ¬¡å§ï¼`);
      game.qIndex = 0;
      game.correctInLevel = 0;
      localStorage.setItem('ruba_qIndex', game.qIndex);
      localStorage.setItem('ruba_correct', game.correctInLevel);
      correctThis.textContent = game.correctInLevel;
      setTimeout(()=> renderQuestion(), 600);
    }
  }

  // å¡«ç©ºæäº¤
  submitFill.addEventListener('click', ()=>{
    const v = parseInt(answerInput.value,10);
    if(Number.isFinite(v)) handleAnswer(v);
    else alert('è¯·è¾“å…¥æ•°å­—ç­”æ¡ˆ');
  });
  answerInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ submitFill.click(); } });

  // åˆ‡æ¢æ¨¡å¼
  modeToggle.addEventListener('click', ()=>{
    if(mode === 'choose'){ mode = 'fill'; modeToggle.textContent = 'åˆ‡æ¢åˆ° é€‰æ‹©é¢˜æ¨¡å¼'; }
    else { mode = 'choose'; modeToggle.textContent = 'åˆ‡æ¢åˆ° å¡«ç©ºé¢˜æ¨¡å¼'; }
    renderQuestion();
  });

  // ç«–å¼æ˜¾ç¤ºé€»è¾‘
  let isVertShown = false;
  showVertBtn.addEventListener('click', ()=>{
    isVertShown = !isVertShown;
    showVertBtn.textContent = isVertShown ? 'éšè—ç«–å¼' : 'æ˜¾ç¤ºç«–å¼';
    if(isVertShown && currentQ) renderVertical(currentQ);
    else verticalArea.textContent = 'å·²éšè—ç«–å¼';
  });

  // ç«–å¼æ ¼å¼åŒ–ï¼ˆä¸æ˜¾ç¤ºç»“æœï¼‰
  function renderVertical(q){
    const a = q.num1.toString();
    const b = q.num2.toString();
    const maxlen = Math.max(a.length, b.length) + 1;
    const pad = (s, len) => s.padStart(len, ' ');
    const line1 = pad(a, maxlen);
    const line2 = q.operator + pad(b, maxlen - 1);
    const hr = '-'.repeat(maxlen);
    const empty = ' '.repeat(maxlen);
    verticalArea.textContent = `${line1}\n${line2}\n${hr}\n${empty}`;
  }

  // é‡ç½®
  resetBtn.addEventListener('click', ()=>{
    if(confirm('ç¡®è®¤é‡ç½®å…³å¡ä¸é±¼å¹²åˆ†æ•°å—ï¼Ÿ')) {
      game = { level:1, score:0, qIndex:0, correctInLevel:0 };
      localStorage.setItem('ruba_level', '1');
      localStorage.setItem('ruba_score', '0');
      localStorage.setItem('ruba_qIndex', '0');
      localStorage.setItem('ruba_correct', '0');
      levelLabel.textContent = '1';
      levelNumber.textContent = '1';
      scoreEl.textContent = '0';
      qIdx.textContent = '0';
      qNumber.textContent = '1';
      correctThis.textContent = '0';
      renderQuestion();
    }
  });

  // init first question
  renderQuestion();
})();
</script>
</body>

</html>
